


/*
* Author: RMST
* Version: 3.0
*/



const CONFIG={MAX_FILE_SIZE_MB:20,THUMBNAIL_WIDTH:300},AppState={pages:[],selectedPageId:null,isProcessing:!1,nextId:1},Elements={dropZone:document.querySelector(".drop-zone"),fileInput:document.getElementById("file-input"),previewsList:document.getElementById("previews-list"),pageCount:document.getElementById("page-count"),clearBtn:document.getElementById("clear-all-btn"),placeholderMsg:document.querySelector(".placeholder-message"),splitView:document.querySelector(".split-view"),sourceText:document.getElementById("source-text"),targetText:document.getElementById("target-text"),ocrLang:document.getElementById("ocr-lang"),transLang:document.getElementById("trans-lang"),enhancedOcr:document.getElementById("enhanced-ocr"),processAllBtn:document.getElementById("process-all-btn"),progressBar:document.getElementById("global-progress"),progressContainer:document.querySelector(".progress-section"),statusText:document.getElementById("global-status-text"),progressPercent:document.getElementById("progress-percent"),btnDownloadTxt:document.getElementById("download-txt-btn"),btnDownloadPdf:document.getElementById("download-pdf-btn"),toastContainer:null};function init(){createToastContainer(),setupEventListeners()}function createToastContainer(){let e=document.createElement("div");e.className="toast-container",document.body.appendChild(e),Elements.toastContainer=e}function setupEventListeners(){Elements.fileInput.addEventListener("change",handleFileSelect),Elements.dropZone.addEventListener("dragover",e=>{e.preventDefault(),Elements.dropZone.classList.add("drag-over")}),Elements.dropZone.addEventListener("dragleave",()=>{Elements.dropZone.classList.remove("drag-over")}),Elements.dropZone.addEventListener("drop",e=>{e.preventDefault(),Elements.dropZone.classList.remove("drag-over"),handleFiles(e.dataTransfer.files)}),Elements.dropZone.addEventListener("click",()=>{Elements.fileInput.click()}),Elements.dropZone.addEventListener("keydown",e=>{("Enter"===e.key||" "===e.key)&&(e.preventDefault(),Elements.fileInput.click())}),Elements.clearBtn.addEventListener("click",clearAll),Elements.processAllBtn.addEventListener("click",runBatchProcessing),document.querySelectorAll(".copy-btn").forEach(e=>{e.addEventListener("click",e=>{let t=e.target.closest(".copy-btn").dataset.target,a=document.getElementById(t).value;copyToClipboard(a)})})}function showToast(e,t="info"){let a=document.createElement("div");a.className=`toast ${t}`;let n='<svg class="icon-svg" viewBox="0 0 24 24"><path d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" /></svg>';"success"===t&&(n='<svg class="icon-svg" viewBox="0 0 24 24"><path d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'),"error"===t&&(n='<svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>'),a.innerHTML=`
        <span class="toast-icon">${n}</span>
        <span class="toast-message">${e}</span>
    `,Elements.toastContainer.appendChild(a),setTimeout(()=>{a.style.animation="fadeOut 0.3s forwards",setTimeout(()=>a.remove(),300)},4e3)}function showConfirmDialog(e,t,a){let n=document.createElement("div");n.className="modal-overlay",n.innerHTML=`
        <div class="custom-modal">
            <h3 class="modal-title">${e}</h3>
            <p class="modal-desc">${t}</p>
            <div class="modal-actions">
                <button class="btn-secondary cancel-btn">Cancel</button>
                <button class="btn-danger confirm-btn">Yes, I'm sure</button>
            </div>
        </div>
    `,document.body.appendChild(n);let s=()=>{n.style.animation="fadeOut 0.2s forwards",setTimeout(()=>n.remove(),200)};n.querySelector(".cancel-btn").addEventListener("click",s),n.querySelector(".confirm-btn").addEventListener("click",()=>{a(),s()}),n.addEventListener("click",e=>{e.target===n&&s()})}function handleFileSelect(e){e.target.files.length>0&&handleFiles(e.target.files)}async function handleFiles(e){for(let t of e){if(t.size>1048576*CONFIG.MAX_FILE_SIZE_MB){showToast(`File ${t.name} is too large (Max ${CONFIG.MAX_FILE_SIZE_MB}MB)`,"error");continue}"application/pdf"===t.type?await processPDF(t):t.type.startsWith("image/")?await processImage(t):showToast(`Unsupported file type: ${t.type}`,"error")}updateUI()}async function processImage(e){return new Promise(t=>{let a=new FileReader;a.onload=a=>{let n=createPageObject(e.name,"image",a.target.result);AppState.pages.push(n),addPreviewToUI(n),t()},a.readAsDataURL(e)})}async function processPDF(e){try{let t=await e.arrayBuffer(),a=await pdfjsLib.getDocument({data:t}).promise;for(let n=1;n<=a.numPages;n++){let s=await a.getPage(n),r=s.getViewport({scale:1.5}),o=document.createElement("canvas"),l=o.getContext("2d");o.height=r.height,o.width=r.width,await s.render({canvasContext:l,viewport:r}).promise;let i=o.toDataURL("image/png"),c=createPageObject(`${e.name} (Page ${n})`,"pdf-page",i);AppState.pages.push(c),addPreviewToUI(c)}}catch(d){console.error(d),showToast("Error processing PDF file.","error")}}function createPageObject(e,t,a){return{id:AppState.nextId++,name:e,type:t,imageSource:a,rotation:0,ocrText:"",translation:"",status:"ready",isIncluded:!0}}function updateUI(){Elements.pageCount.textContent=AppState.pages.length,AppState.pages.length>0?(document.querySelector(".empty-state").style.display="none",AppState.selectedPageId||selectPage(AppState.pages[0].id)):(document.querySelector(".empty-state").style.display="block",Elements.splitView.style.display="none",Elements.placeholderMsg.style.display="block")}function addPreviewToUI(e){let t=document.createElement("div");t.className="preview-item",t.dataset.id=e.id,t.innerHTML=`
        <img src="${e.imageSource}" class="preview-thumb" alt="Preview">
        <div class="preview-info">
            <div class="preview-name" title="${e.name}">${e.name}</div>
            <div class="preview-meta">${"pdf-page"===e.type?"PDF Page":"Image"}</div>
            <div class="preview-actions">
                <button class="btn-icon-sm rotate-cw-btn" title="Rotate Right">
                    <svg class="icon-svg" style="width:14px;height:14px;" viewBox="0 0 24 24"><path d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>
                </button>
                <button class="btn-icon-sm remove-btn" title="Remove">
                    <svg class="icon-svg" style="width:14px;height:14px;" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
        </div>
        <div class="preview-status" id="status-${e.id}"></div>
    `,t.querySelector(".rotate-cw-btn").addEventListener("click",t=>{t.stopPropagation(),rotatePage(e.id,90)}),t.querySelector(".remove-btn").addEventListener("click",t=>{t.stopPropagation(),removePage(e.id)}),t.addEventListener("click",()=>selectPage(e.id)),Elements.previewsList.appendChild(t),updateUI()}function selectPage(e){AppState.selectedPageId=e,document.querySelectorAll(".preview-item").forEach(t=>{t.classList.toggle("active",parseInt(t.dataset.id)===e)});let t=AppState.pages.find(t=>t.id===e);t&&(Elements.placeholderMsg.style.display="none",Elements.splitView.style.display="grid",Elements.sourceText.value=t.ocrText||"",Elements.targetText.value=t.translation||"",Elements.sourceText.oninput=e=>{t.ocrText=e.target.value},Elements.targetText.oninput=e=>{t.translation=e.target.value})}function rotatePage(e,t){let a=AppState.pages.find(t=>t.id===e);if(!a)return;a.rotation=(a.rotation+t)%360;let n=document.querySelector(`.preview-item[data-id="${e}"]`),s=n.querySelector(".preview-thumb");s.style.transform=`rotate(${a.rotation}deg)`}function removePage(e){AppState.pages=AppState.pages.filter(t=>t.id!==e);let t=document.querySelector(`.preview-item[data-id="${e}"]`);t&&t.remove(),AppState.selectedPageId===e&&(AppState.selectedPageId=null,AppState.pages.length>0?selectPage(AppState.pages[0].id):updateUI()),updateUI()}function clearAll(){0!==AppState.pages.length&&showConfirmDialog("Clear All Pages?","This will remove all uploaded images and extracted text. This action cannot be undone.",()=>{AppState.pages=[],Elements.previewsList.innerHTML='<div class="empty-state"><p>No files loaded yet.</p></div>',AppState.selectedPageId=null,updateUI(),showToast("All pages cleared.","info")})}async function copyToClipboard(e){if(!e){showToast("Nothing to copy!","info");return}try{await navigator.clipboard.writeText(e),showToast("Copied to clipboard!","success")}catch(t){console.error("Failed to copy",t),showToast("Failed to copy text.","error")}}let tesseractWorker=null;async function getTesseractWorker(e){return tesseractWorker?await tesseractWorker.reinitialize(e):tesseractWorker=await Tesseract.createWorker(e,1,{}),tesseractWorker}async function runBatchProcessing(){if(AppState.isProcessing)return;let e=AppState.pages.filter(e=>!e.ocrText&&e.isIncluded);if(0===e.length){showToast("No new pages to process!","info");return}AppState.isProcessing=!0,Elements.processAllBtn.disabled=!0,Elements.processAllBtn.innerHTML='<svg class="icon-svg spinner" viewBox="0 0 24 24"><path d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg> Processing...',Elements.progressContainer.style.display="flex",updateGlobalProgress(0);let t=e.length,a=0,n="auto"===Elements.ocrLang.value?"eng":Elements.ocrLang.value,s=Elements.enhancedOcr.checked,r=null;try{for(let o of(r=await getTesseractWorker(n),e))try{updateStatus(`Processing Page ${o.id}...`),updateStatusVisual(o.id,"running");let l=await prepareImageForOCR(o.imageSource,o.rotation,s),i=await r.recognize(l);o.ocrText=cleanOCRText(i.data),o.ocrText.trim(),o.status="done",updateStatusVisual(o.id,"done"),AppState.selectedPageId===o.id&&(Elements.sourceText.value=o.ocrText),"none"!==Elements.transLang.value&&await translatePage(o)}catch(c){console.error(`Error processing page ${o.id}:`,c),o.status="error",updateStatusVisual(o.id,"error"),showToast(`Failed to process Page ${o.id}`,"error")}finally{a++,updateGlobalProgress(a/t*100)}updateStatus("All pages processed."),showToast("Batch processing complete!","success")}catch(d){console.error("Global OCR Error:",d),showToast("Critial error starting OCR engine.","error")}finally{AppState.isProcessing=!1,Elements.processAllBtn.disabled=!1,Elements.processAllBtn.innerHTML='<svg class="icon-svg" style="width: 1em; height: 1em;" viewBox="0 0 24 24"><path d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" /></svg> Run All',updateGlobalProgress(100),Elements.btnDownloadTxt.disabled=!1,Elements.btnDownloadPdf.disabled=!1}}async function prepareImageForOCR(e,t,a){return new Promise(n=>{let s=new Image;s.onload=()=>{let e=document.createElement("canvas"),r=e.getContext("2d");if(90===t||270===t?(e.width=s.height,e.height=s.width):(e.width=s.width,e.height=s.height),r.translate(e.width/2,e.height/2),r.rotate(t*Math.PI/180),r.drawImage(s,-s.width/2,-s.height/2),r.resetTransform(),a){let o=r.getImageData(0,0,e.width,e.height),l=o.data;for(let i=0;i<l.length;i+=4){let c=(l[i]+l[i+1]+l[i+2])/3,d=c>128?255:0;l[i]=d,l[i+1]=d,l[i+2]=d}r.putImageData(o,0,0)}n(e.toDataURL("image/png"))},s.src=e})}async function translatePage(e){let t=Elements.transLang.value;"none"!==t&&(updateStatus(`Translating Page ${e.id}...`),await new Promise(e=>setTimeout(e,500)),e.translation=`[${t.toUpperCase()}] ${e.ocrText}

(Translation API requires key. This is a demo placeholder.)`,AppState.selectedPageId===e.id&&(Elements.targetText.value=e.translation))}function downloadTxt(){let e=AppState.pages.filter(e=>e.isIncluded);if(0===e.length){showToast("No pages to export.","error");return}let t="";e.forEach(e=>{t+=`--- ${e.name} ---
`,t+=`[Original]
${e.ocrText||"(No Text extracted)"}

`,e.translation&&(t+=`[Translation]
${e.translation}

`),t+="\n"+"=".repeat(20)+"\n\n"});let a=new Blob([t],{type:"text/plain"}),n=URL.createObjectURL(a),s=document.createElement("a");s.href=n,s.download="ocr-translation-result.txt",s.click(),URL.revokeObjectURL(n),showToast("Text file downloaded.","success")}async function downloadPdf(){let e=AppState.pages.filter(e=>e.isIncluded);if(0===e.length){showToast("No pages to export.","error");return}try{updateStatus("Generating PDF...");let t=await PDFLib.PDFDocument.create(),a=await t.embedFont(PDFLib.StandardFonts.Helvetica),n=await t.embedFont(PDFLib.StandardFonts.HelveticaBold);for(let s of e){let r=t.addPage(),{width:o,height:l}=r.getSize(),i=l-50;r.drawText(`Source: ${s.name}`,{x:50,y:i,size:14,font:n,color:PDFLib.rgb(0,0,0)}),i-=33.599999999999994;let c=[{title:"Extracted Text",content:s.ocrText||"(No text found)"},];for(let d of(s.translation&&c.push({title:"Translation",content:s.translation}),c)){i<66.8&&(r=t.addPage(),i=l-50),r.drawText(d.title,{x:50,y:i,size:12,font:n,color:PDFLib.rgb(.3,.3,.3)}),i-=25.199999999999996;let p=d.content.split("\n");for(let g of p){if(!g.trim()){i-=16.799999999999997;continue}let u=g.split(" "),$="";for(let m of u){let _=$+m+" ",v=a.widthOfTextAtSize(_,12);if(v>o-100){i<66.8&&(r=t.addPage(),i=l-50);try{r.drawText($,{x:50,y:i,size:12,font:a})}catch(h){console.warn("Character encoding issue",h),r.drawText($.replace(/[^\x00-\x7F]/g,"?"),{x:50,y:i,size:12,font:a})}i-=16.799999999999997,$=m+" "}else $=_}if($.trim()){i<66.8&&(r=t.addPage(),i=l-50);try{r.drawText($,{x:50,y:i,size:12,font:a})}catch(w){r.drawText($.replace(/[^\x00-\x7F]/g,"?"),{x:50,y:i,size:12,font:a})}i-=16.799999999999997}}i-=16.799999999999997}}let f=await t.save(),E=new Blob([f],{type:"application/pdf"}),y=URL.createObjectURL(E),x=document.createElement("a");x.href=y,x.download="ocr-result-text.pdf",x.click(),URL.revokeObjectURL(y),updateStatus("PDF Downloaded."),showToast("Text PDF downloaded successfully.","success")}catch(T){console.error("PDF Gen Error:",T),showToast("Failed to generate PDF.","error")}}function updateStatus(e){Elements.statusText.innerText=e}function updateGlobalProgress(e){let t=Math.round(e);Elements.progressBar.style.width=`${t}%`,Elements.progressPercent&&(Elements.progressPercent.textContent=`${t}%`),t>=100?(Elements.progressBar.classList.add("complete"),Elements.statusText.textContent="100% Completed"):Elements.progressBar.classList.remove("complete")}function updateStatusVisual(e,t){let a=document.getElementById(`status-${e}`);a&&("running"===t?a.innerHTML='<svg class="icon-svg spinner" style="color:var(--primary-color)" viewBox="0 0 24 24"><path d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>':"done"===t?a.innerHTML='<svg class="icon-svg" style="color:var(--secondary-color)" viewBox="0 0 24 24"><path d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>':a.innerHTML="")}function cleanOCRText(e){let t=/[\p{L}\p{N}]/u,a=[];return e.lines?(e.lines.forEach(e=>{let n=e.words.filter(e=>{if(e.confidence<60)return!1;let t=e.text.trim();return!(!t||1===t.length&&!/[\p{L}\p{N}]/u.test(t)||/^[^\p{L}\p{N}]+$/u.test(t))});if(0===n.length)return;let s=n.map(e=>e.text).join(" ");t.test(s)&&0!==(s=s.replace(/\|/g,"").replace(/_/g,"").trim()).length&&a.push(s)}),a.join("\n")):""}Elements.btnDownloadTxt.addEventListener("click",downloadTxt),Elements.btnDownloadPdf.addEventListener("click",downloadPdf),init();